<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="description" content="Books catalog and announcements from St. Expedite Press." />
  <meta name="theme-color" content="#050807" />
  <meta name="color-scheme" content="dark" />
  <meta property="og:site_name" content="St. Expedite Press" />
  <meta property="og:type" content="website" />
  <meta property="og:title" content="Books &mdash; St. Expedite Press" />
  <meta property="og:description" content="Books catalog and announcements." />
  <title>Books &mdash; St. Expedite Press</title>

  <!-- Same font stack as portal -->
  <link rel="icon" href="assets/img/favicon.svg" type="image/svg+xml" />
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;600&family=Cormorant+Garamond:wght@300;400;600&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="assets/css/hero-bar.css" />
  <link rel="stylesheet" href="assets/css/footer.css" />
  <link rel="stylesheet" href="assets/css/base.css" />
  <link rel="stylesheet" href="assets/css/effects.css" />
  <link rel="stylesheet" href="assets/css/a11y.css" />
  <link rel="stylesheet" href="assets/css/content-shell.css" />

  <style>
  /* Focus parity: match hover glow when navigating by keyboard */
  .header-nav a:focus-visible {
    border-color: rgba(42,255,138,0.48);
    background: rgba(42,255,138,0.08);
    filter: brightness(1.2) contrast(1.05);
    text-shadow:
      0 0 10px var(--green-hot-1),
      0 0 24px var(--green-hot-2);
  }

  /***********************************************************************
   * FILTER BAR - SERIES / IMPRINT FILTERS
   **********************************************************************/
  .filter-bar-wrapper {
    margin: 3vh auto 2vh;
    max-width: 1024px;
    text-align: center;
  }

  .books-intro {
    max-width: 1024px;
    margin: 1.2vh auto 2vh;
    text-align: center;
    line-height: 1.55;
    opacity: 0.95;
    text-shadow: 0 0 8px var(--green-3);
  }

  .books-intro__actions {
    margin-top: 0.8rem;
    display: flex;
    justify-content: center;
    gap: 0.65rem;
    flex-wrap: wrap;
  }

  .books-intro__cta {
    border: 1px solid var(--green-2);
    background: rgba(0,0,0,0.72);
    color: var(--green-base);
    border-radius: 999px;
    padding: 0.5rem 0.95rem;
    font-family: "Cinzel", serif;
    letter-spacing: 0.14em;
    text-transform: uppercase;
    font-size: 0.74rem;
    text-decoration: none;
    box-shadow: 0 0 10px rgba(0,0,0,0.9), 0 0 14px var(--green-3);
    transition: 0.2s ease;
  }

  .books-intro__cta:hover,
  .books-intro__cta:focus-visible {
    border-color: var(--green-hot-2);
    box-shadow: 0 0 12px var(--green-hot-2), 0 0 22px var(--green-hot-3);
  }

  .filter-heading {
    font-size: 1.1rem;
    letter-spacing: .14em;
    text-transform: uppercase;
    opacity: .9;
    margin-bottom: 0.7rem;
    text-shadow: 0 0 8px var(--green-2);
  }

  .filter-bar {
    display: flex;
    flex-wrap: wrap;
    justify-content: center;
    gap: 0.5rem;
  }

  .filter-button {
    border: 1px solid var(--green-2);
    background: rgba(0,0,0,0.7);
    color: var(--green-base);
    font-family: "Cinzel", serif;
    font-size: 0.82rem;
    letter-spacing: .14em;
    text-transform: uppercase;
    padding: 0.5rem 0.9rem;
    cursor: pointer;
    border-radius: 999px;
    text-shadow: 0 0 6px var(--green-1);
    box-shadow:
      0 0 8px rgba(0,0,0,0.9),
      0 0 12px var(--green-3);
    transition: all .2s ease;
  }

  .filter-button:hover {
    border-color: var(--green-hot-2);
    box-shadow:
      0 0 10px var(--green-hot-2),
      0 0 20px var(--green-hot-3);
  }

  .filter-button:focus-visible {
    border-color: var(--green-hot-2);
    box-shadow:
      0 0 10px var(--green-hot-2),
      0 0 20px var(--green-hot-3);
  }

  .filter-button.is-active {
    background: rgba(42,255,138,0.1);
    border-color: var(--green-hot-1);
    box-shadow:
      0 0 12px var(--green-hot-1),
      0 0 26px var(--green-hot-2);
  }

  /***********************************************************************
   * BOOK GRID LAYOUT
   **********************************************************************/
  .books-grid {
    max-width: 1200px;
    margin: 0 auto;
    display: grid;
    grid-template-columns: repeat(4, minmax(0, 1fr));
    gap: 1.8rem;
  }

  @media (max-width: 1050px) {
    .books-grid {
      grid-template-columns: repeat(3, minmax(0, 1fr));
    }
  }

  @media (max-width: 768px) {
    .books-grid {
      grid-template-columns: repeat(2, minmax(0, 1fr));
    }
  }

  @media (max-width: 540px) {
    .books-grid {
      grid-template-columns: 1fr;
    }
  }

  /***********************************************************************
   * BOOK CARD - VISUAL & INTERACTION
   **********************************************************************/
  .book-card {
    position: relative;
    background: rgba(0,0,0,0.75);
    border-radius: 20px;
    border: 1px solid rgba(42,255,138,0.2);
    overflow: hidden;
    padding: 0.75rem 0.75rem 0.9rem;
    display: flex;
    flex-direction: column;
    gap: 0.6rem;
    box-shadow:
      0 0 12px rgba(0,0,0,0.9),
      0 0 20px var(--green-3);
    transform: translate3d(0,0,0);
    will-change: transform, box-shadow;
    transition: transform .2s ease, box-shadow .2s ease, border-color .2s ease;
  }

  .book-card::before {
    /* subtle static/glitch overlay for cards */
    content: "";
    position: absolute;
    inset: 0;
    background:
      repeating-linear-gradient(
        to bottom,
        rgba(42,255,138,0.03) 0px,
        rgba(42,255,138,0.03) 1px,
        rgba(42,255,138,0.00) 2px
      );
    opacity: 0.6;
    mix-blend-mode: soft-light;
    pointer-events: none;
  }

  .book-card:hover {
    transform: translate3d(0,-4px,0) scale(1.01);
    border-color: var(--green-hot-2);
    box-shadow:
      0 0 14px rgba(0,0,0,0.9),
      0 0 26px var(--green-hot-2),
      0 0 48px var(--green-hot-3);
  }

  .book-card:focus-within {
    transform: translate3d(0,-4px,0) scale(1.01);
    border-color: var(--green-hot-2);
    box-shadow:
      0 0 14px rgba(0,0,0,0.9),
      0 0 26px var(--green-hot-2),
      0 0 48px var(--green-hot-3);
  }

  .book-cover-wrap {
    position: relative;
    border-radius: 14px;
    overflow: hidden;
    aspect-ratio: 2 / 3; /* 2:3 book cover ratio */
    background:
      linear-gradient(135deg, rgba(42,255,138,0.12), rgba(217,106,255,0.12));
    box-shadow:
      0 0 12px rgba(0,0,0,0.9),
      0 0 18px var(--green-2);
  }

  /* If you later want real cover images, put <img> inside .book-cover-wrap */
  .book-cover-img {
    position: absolute;
    inset: 0;
    width: 100%;
    height: 100%;
    object-fit: cover;
    display: block;
  }

  .book-cover-placeholder {
    position: absolute;
    inset: 0;
    display: flex;
    align-items: center;
    justify-content: center;
    font-family: "Cinzel", serif;
    text-transform: uppercase;
    letter-spacing: .18em;
    font-size: 0.8rem;
    text-align: center;
    color: var(--green-base);
    text-shadow:
      0 0 6px var(--green-1),
      0 0 12px var(--green-2);
  }

  .book-series-pill {
    position: absolute;
    left: 8px;
    top: 8px;
    padding: 0.2rem 0.5rem;
    border-radius: 999px;
    font-size: 0.65rem;
    letter-spacing: .14em;
    text-transform: uppercase;
    background: rgba(0,0,0,0.68);
    border: 1px solid rgba(42,255,138,0.4);
    text-shadow: 0 0 4px var(--green-2);
  }

  .book-meta {
    display: flex;
    flex-direction: column;
    gap: 0.1rem;
    margin-top: 0.4rem;
    flex: 1 1 auto;
  }

  .book-title {
    font-family: "Cinzel", serif;
    font-size: 1.0rem;
    letter-spacing: .07em;
    text-transform: uppercase;
    text-shadow: 0 0 7px var(--green-1);
    min-height: 2.8em;
  }

  .book-author {
    font-size: 0.85rem;
    opacity: .9;
    letter-spacing: .04em;
    min-height: 1.3em;
  }

  .book-actions {
    margin-top: auto;
    padding-top: 0.4rem;
    display: flex;
    justify-content: space-between;
    gap: 0.4rem;
  }

  .book-btn {
    flex: 1 1 auto;
    width: 100%;
    font-family: "Cinzel", serif;
    font-size: 0.78rem;
    letter-spacing: .14em;
    text-transform: uppercase;
    border-radius: 999px;
    padding: 0.45rem 0.4rem;
    border: 1px solid var(--green-2);
    background: rgba(0,0,0,0.85);
    color: var(--green-base);
    cursor: pointer;
    text-align: center;
    text-shadow: 0 0 6px var(--green-1);
    box-shadow: 0 0 10px rgba(0,0,0,0.9);
    transition: all .2s ease;
  }

  .book-btn:hover {
    border-color: var(--green-hot-2);
    box-shadow:
      0 0 10px var(--green-hot-2),
      0 0 22px var(--green-hot-3);
  }

  .book-btn:focus-visible {
    border-color: var(--green-hot-2);
    box-shadow:
      0 0 10px var(--green-hot-2),
      0 0 22px var(--green-hot-3);
  }

  .book-btn--primary {
    background: rgba(42,255,138,0.12);
  }

  @media (max-width: 768px) {
    .filter-bar-wrapper,
    .books-grid {
      max-width: 34rem;
      margin-left: auto;
      margin-right: auto;
    }

    .filter-bar {
      flex-direction: column;
      gap: 0.4rem;
    }

    .filter-button {
      width: 100%;
      text-align: center;
      box-shadow:
        0 0 6px rgba(0,0,0,0.7),
        0 0 12px var(--green-3);
    }

    .books-grid {
      grid-template-columns: 1fr;
      gap: 1.4rem;
      margin-top: 4vh;
    }

    .book-card {
      padding: 1rem;
      box-shadow:
        0 0 10px rgba(0,0,0,0.85),
        0 0 16px var(--green-3);
    }

    .book-actions {
      flex-direction: column;
    }
  }

  /***********************************************************************
   * BOOK MODAL - DETAIL VIEW
   **********************************************************************/
  .book-modal-backdrop {
    position: fixed;
    inset: 0;
    background: rgba(0,0,0,0.86);
    backdrop-filter: blur(3px);
    display: none;
    align-items: center;
    justify-content: center;
    z-index: 200;
  }

  .book-modal-backdrop.is-visible {
    display: flex;
  }

  .book-modal {
    position: relative;
    max-width: 640px;
    width: 92vw;
    max-height: 80vh;
    background: radial-gradient(circle at top, rgba(42,255,138,0.08), #040707 60%);
    border-radius: 22px;
    border: 1px solid rgba(42,255,138,0.5);
    box-shadow:
      0 0 18px var(--green-1),
      0 0 36px var(--green-2);
    padding: 1.1rem 1.3rem 1.3rem;
    overflow-y: auto;
  }

  .book-modal-close {
    position: absolute;
    top: 0.4rem;
    right: 0.6rem;
    border: none;
    background: transparent;
    color: var(--green-base);
    font-size: 1.2rem;
    cursor: pointer;
    text-shadow: 0 0 10px var(--green-1);
  }

  .book-modal-series {
    font-size: 0.8rem;
    letter-spacing: .16em;
    text-transform: uppercase;
    opacity: .9;
    margin-bottom: 0.3rem;
  }

  .book-modal-title {
    font-family: "Cinzel", serif;
    font-size: 1.3rem;
    letter-spacing: .12em;
    text-transform: uppercase;
    margin-bottom: 0.2rem;
    text-shadow: 0 0 8px var(--green-1);
  }

  .book-modal-author {
    font-size: 0.9rem;
    opacity: .95;
    margin-bottom: 0.4rem;
  }

  .book-modal-description {
    font-size: 0.94rem;
    line-height: 1.45;
    opacity: .96;
  }

  .book-modal-footer {
    margin-top: 0.9rem;
    display: flex;
    justify-content: flex-end;
  }

  .book-modal-buy {
    font-family: "Cinzel", serif;
    font-size: 0.82rem;
    letter-spacing: .14em;
    text-transform: uppercase;
    border-radius: 999px;
    padding: 0.5rem 1.3rem;
    border: 1px solid var(--green-hot-2);
    background: rgba(42,255,138,0.14);
    color: var(--green-base);
    cursor: pointer;
    text-shadow: 0 0 6px var(--green-1);
    box-shadow:
      0 0 10px rgba(0,0,0,0.9),
      0 0 22px var(--green-hot-2);
  }

  /***********************************************************************
   * FOOTER / SMALL PRINT
   **********************************************************************/
  </style>
</head>

<body>

  <a class="skip-link" href="#main">Skip to content</a>

  <div class="hero-bar" role="navigation" aria-label="Social media">
    <div class="hero-bar__inner">
      <a class="hero-bar__icon" href="https://x.com/stex_press" target="_blank" rel="noopener noreferrer" aria-label="X" title="X">
        <svg viewBox="0 0 24 24" aria-hidden="true" focusable="false" fill="none" stroke="currentColor" stroke-width="2.2" stroke-linecap="round">
          <path d="M6 6l12 12M18 6L6 18" />
        </svg>
      </a>
      <a class="hero-bar__icon" href="https://ecoamericana.substack.com/s/ephemera" target="_blank" rel="noopener noreferrer" aria-label="Substack" title="Substack">
        <svg viewBox="0 0 24 24" aria-hidden="true" focusable="false" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round">
          <path d="M7 7h10M7 12h10M7 17h10" />
        </svg>
      </a>
      <a class="hero-bar__icon" href="https://t.me/joinchat/vvALfKUrw0k5NjYx" target="_blank" rel="noopener noreferrer" aria-label="Telegram" title="Telegram">
        <svg viewBox="0 0 24 24" aria-hidden="true" focusable="false" fill="none" stroke="currentColor" stroke-width="2" stroke-linejoin="round" stroke-linecap="round">
          <path d="M21 5 3 12l7 2 2 7 9-16Z" />
          <path d="M10 14 21 5" />
        </svg>
      </a>
      <a class="hero-bar__icon" href="https://github.com/orgs/St-Expedite-Press/repositories" target="_blank" rel="noopener noreferrer" aria-label="GitHub" title="GitHub">
        <svg viewBox="0 0 24 24" aria-hidden="true" focusable="false" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <path d="M9 19c-5 1.5-5-2.5-7-3m14 6v-3.87a3.37 3.37 0 0 0-.94-2.61c3.14-.35 6.44-1.54 6.44-7A5.44 5.44 0 0 0 20 4.77 5.07 5.07 0 0 0 19.91 1S18.73.65 16 2.48a13.38 13.38 0 0 0-7 0C6.27.65 5.09 1 5.09 1A5.07 5.07 0 0 0 5 4.77a5.44 5.44 0 0 0-1.5 3.78c0 5.42 3.3 6.61 6.44 7A3.37 3.37 0 0 0 9 18.13V22"/>
        </svg>
      </a>
    </div>
  </div>

  <!-- Uses interior-content-template.html (content-class page: canonical source) -->
  <!-- Ambient grain + cursor glow -->
  <div class="texture--grain"></div>
  <div class="cursor-glow"></div>

  <main id="main" class="page">

    <!-- HEADER (canonical from interior-content-template.html) -->
    <header class="site-header">
      <div class="site-brand">
        <div class="site-eyebrow">ST. EXPEDITE PRESS</div>
        <h1 class="site-title">BOOKS</h1>
        <div class="site-subtitle">Books & Imprints</div>
        <div class="site-header-divider"></div>
      </div>

      <nav class="header-nav">
        <a href="index.html">Portal</a>
        <a href="books.html" aria-current="page">Books</a>
        <a href="gallery.html">Merch</a>
        <a href="under-construction.html">Lab</a>
        <a href="mission.html">Mission</a>
        <a href="contact.html">Contact</a>
      </nav>
    </header>

    <!-- TEMPLATE-SLOT: filter / local controls -->
    <!-- FILTER BAR: series / imprint filters -->
    <section class="filter-bar-wrapper">
      <h2 class="filter-heading">Filter by Imprint</h2>
      <div class="filter-bar" id="filterBar">
        <!-- data-filter values correspond to book-card data-series attributes -->
        <button class="filter-button is-active" type="button" data-filter="all">All</button>
        <button class="filter-button" type="button" data-filter="sexp-originals">SEXP (Flagship / Originals)</button>
        <button class="filter-button" type="button" data-filter="library-of-the-southern-civilization">Library of the Southern Civilization</button>
        <button class="filter-button" type="button" data-filter="european-classics-modernists">European Classics &amp; Modernists</button>
      </div>
    </section>

    <section class="books-intro" aria-label="Books purchase and contact actions">
      <p>
        Catalog data loads live from the press database. Open any title for details, then use
        <strong>Purchase</strong> to jump straight to current marketplace listings.
      </p>
      <div class="books-intro__actions">
        <a class="books-intro__cta" href="https://www.amazon.com/s?k=C.+Sandbatch" target="_blank" rel="noopener noreferrer">Find on Amazon</a>
        <a class="books-intro__cta" href="contact.html">Bulk / Rights Inquiries</a>
      </div>
    </section>

    <!-- TEMPLATE-SLOT: primary grid (.books-grid) -->
    <!-- BOOK GRID -->
    <section class="books-grid" id="booksGrid">
      <article class="book-card" id="booksLoadingCard">
        <div class="book-cover-wrap">
          <div class="book-cover-placeholder">Loading</div>
          <div class="book-series-pill">Catalog</div>
        </div>
        <div class="book-meta">
          <div class="book-title">Loading Oncoming Projects</div>
          <div class="book-author">Fetching canonical catalog...</div>
        </div>
      </article>
    </section>

    <!-- TEMPLATE-SLOT: footer -->
    <!-- FOOTER -->
    <footer class="sep-footer">
      <p class="sep-footer__coords">29.9511&deg; N &mdash; 90.0715&deg; W</p>
      <p class="sep-footer__lede">...in the key of Night.</p>
      <div class="sep-footer__divider">&#9651; &#10013; &#9651;</div>
      <div class="sep-footer__links">
        <a href="services.html">Services</a> // <a href="submit.html">Submission</a> // <a href="contact.html">Contact</a>
      </div>
    </footer>
  </main>

  <!-- TEMPLATE-SLOT: modals -->
  <!-- BOOK MODAL STRUCTURE -->
  <div class="book-modal-backdrop" id="bookModalBackdrop" aria-hidden="true">
    <div class="book-modal" role="dialog" aria-modal="true" aria-labelledby="bookModalTitle" aria-describedby="bookModalDescription" tabindex="-1">
      <button class="book-modal-close" type="button" aria-label="Close dialog">&times;</button>
      <div class="book-modal-series" id="bookModalSeries"></div>
      <div class="book-modal-title" id="bookModalTitle"></div>
      <div class="book-modal-author" id="bookModalAuthor"></div>
      <div class="book-modal-description" id="bookModalDescription"></div>
      <div class="book-modal-footer">
        <a href="#" class="book-modal-buy" id="bookModalBuy" target="_blank" rel="noopener noreferrer">
          Purchase
        </a>
      </div>
    </div>
  </div>

  <!-- TEMPLATE-SLOT: page-specific scripts (cursor glow, filters, modal) -->
  <script src="assets/js/modal-utils.js"></script>
  <script src="assets/js/cursor-glow.js"></script>
  <script>
  function escapeHtml(value) {
    return String(value || '')
      .replaceAll('&', '&amp;')
      .replaceAll('<', '&lt;')
      .replaceAll('>', '&gt;')
      .replaceAll('"', '&quot;')
      .replaceAll("'", '&#39;');
  }

  function renderBooksCatalog(projects) {
    const booksGrid = document.getElementById('booksGrid');
    if (!booksGrid) return;

    const seriesShort = {
      'sexp-originals': 'SEXP',
      'library-of-the-southern-civilization': 'LSC',
      'european-classics-modernists': 'EURO'
    };

    const items = Array.isArray(projects) ? projects : [];
    if (!items.length) {
      booksGrid.innerHTML = `
        <article class="book-card">
          <div class="book-cover-wrap">
            <div class="book-cover-placeholder">Empty</div>
            <div class="book-series-pill">Catalog</div>
          </div>
          <div class="book-meta">
            <div class="book-title">No Projects Found</div>
            <div class="book-author">The projects catalog is currently empty.</div>
          </div>
        </article>
      `;
      return;
    }

    booksGrid.innerHTML = items.map((project) => {
      const seriesKey = String(project.series_key || '');
      const seriesTitle = String(project.series_title || 'Program');
      const shortCode = seriesShort[seriesKey] || 'BOOK';
      let title = String(project.title || 'Untitled');
      if (project.project_slug === 'les-fievres-et-les-humeurs') {
        title = 'Les Fi√®vres et les Humeurs';
      }
      const subtitle = String(project.subtitle || '').trim();
      const author = String(project.author || 'Unknown');
      const status = String(project.status || 'planned');
      const publicationYear = project.publication_year ? String(project.publication_year) : '';
      const notes = String(project.notes || '').trim();
      const popupDescription = String(project.popup_description || '').trim();
      const coverImage = String(project.cover_image || '').trim();
      const buyUrl = String(project.buy_url || '').trim() || `https://www.amazon.com/s?k=${encodeURIComponent(`${title} ${author}`)}`;

      const descriptionParts = [];
      if (popupDescription) {
        descriptionParts.push(popupDescription);
      } else {
        if (subtitle) descriptionParts.push(subtitle);
        if (publicationYear) descriptionParts.push(`Year: ${publicationYear}`);
        descriptionParts.push(`Status: ${status}`);
        if (notes) descriptionParts.push(notes);
      }
      const description = descriptionParts.join('\n\n');

      return `
        <article
          class="book-card"
          data-series="${escapeHtml(seriesKey)}"
          data-title="${escapeHtml(title)}"
          data-author="${escapeHtml(author)}"
          data-series-label="${escapeHtml(seriesTitle)}"
          data-description="${escapeHtml(description)}"
          data-buy-url="${escapeHtml(buyUrl)}"
        >
          <div class="book-cover-wrap">
            ${coverImage ? `<img class="book-cover-img" src="${escapeHtml(coverImage)}" alt="Cover art for ${escapeHtml(title)}" loading="lazy" decoding="async" />` : `<div class="book-cover-placeholder">${escapeHtml(shortCode)}</div>`}
            <div class="book-series-pill">${escapeHtml(shortCode)}</div>
          </div>
          <div class="book-meta">
            <div class="book-title">${escapeHtml(title)}</div>
            <div class="book-author">${escapeHtml(author)}</div>
          </div>
          <div class="book-actions">
            <button class="book-btn" type="button" data-role="details">More Info</button>
          </div>
        </article>
      `;
    }).join('');
  }

  (function() {
    fetch('/api/projects', { method: 'GET', cache: 'no-store' })
      .then((res) => res.json().catch(() => ({})))
      .then((body) => {
        if (!body || !body.ok) {
          throw new Error((body && body.error) || 'Projects unavailable');
        }
        renderBooksCatalog(body.projects);
      })
      .catch((err) => {
        const booksGrid = document.getElementById('booksGrid');
        if (!booksGrid) return;
        const message = (err && err.message) ? err.message : 'Could not load projects catalog.';
        booksGrid.innerHTML = `
          <article class="book-card">
            <div class="book-cover-wrap">
              <div class="book-cover-placeholder">Error</div>
              <div class="book-series-pill">Catalog</div>
            </div>
            <div class="book-meta">
              <div class="book-title">Could Not Load Books</div>
              <div class="book-author">${escapeHtml(message)}</div>
            </div>
          </article>
        `;
      });
  })();

  /***********************************************************************
   * FILTER LOGIC - SHOW/HIDE BOOK CARDS BY SERIES
   *
   *  - Buttons have data-filter="all|<series>"
   *  - Cards have data-series="<series>"
  **********************************************************************/
  (function() {
    const filterBar = document.getElementById('filterBar');
    const booksGrid = document.getElementById('booksGrid');
    if (!filterBar || !booksGrid) return;

    const buttons = Array.from(filterBar.querySelectorAll('.filter-button'));

    function applyFilter(filter) {
      const cards = Array.from(booksGrid.querySelectorAll('.book-card'));
      cards.forEach(card => {
        const series = card.getAttribute('data-series');
        const match = (filter === 'all') || (series === filter);
        card.style.display = match ? '' : 'none';
      });
    }

    filterBar.addEventListener('click', event => {
      const btn = event.target.closest('.filter-button');
      if (!btn) return;

      const filter = btn.getAttribute('data-filter');
      if (!filter) return;

      buttons.forEach(b => b.classList.toggle('is-active', b === btn));
      applyFilter(filter);
    });

    // initialize with 'all' active
    applyFilter('all');
  })();

  /***********************************************************************
   * BOOK MODAL - POPULATE FROM DATA ATTRIBUTES
   *
   *  - Each .book-card carries data-title, data-author, etc.
   *  - "More Info" button opens the modal with those fields filled in.
   **********************************************************************/
  (function() {
    const backdrop = document.getElementById('bookModalBackdrop');
    const dialogEl = backdrop ? backdrop.querySelector('.book-modal') : null;
    const mainEl = document.getElementById('main');
    const titleEl  = document.getElementById('bookModalTitle');
    const authorEl = document.getElementById('bookModalAuthor');
    const seriesEl = document.getElementById('bookModalSeries');
    const descEl   = document.getElementById('bookModalDescription');
    const buyEl    = document.getElementById('bookModalBuy');

    if (!backdrop || !dialogEl || !titleEl || !authorEl || !seriesEl || !descEl || !buyEl) return;

    const closeButton = backdrop.querySelector('.book-modal-close');

    let lastActiveEl = null;
    let cleanupTrap = null;

    function openModal(card, openerEl) {
      const title   = card.getAttribute('data-title') || '';
      const author  = card.getAttribute('data-author') || '';
      const series  = card.getAttribute('data-series-label') || '';
      const desc    = card.getAttribute('data-description') || '';
      const buyUrl  = card.getAttribute('data-buy-url') || '#';

      titleEl.textContent  = title;
      authorEl.textContent = author;
      seriesEl.textContent = series;
      descEl.textContent   = desc;
      if (buyUrl && buyUrl !== '#') {
        buyEl.setAttribute('href', buyUrl);
        buyEl.textContent = /amazon\./i.test(buyUrl) ? 'Find on Amazon' : 'Purchase';
        buyEl.style.display = '';
      } else {
        buyEl.setAttribute('href', '#');
        buyEl.textContent = 'Purchase';
        buyEl.style.display = 'none';
      }

      backdrop.classList.add('is-visible');
      backdrop.setAttribute('aria-hidden', 'false');

      lastActiveEl = openerEl || document.activeElement;
      document.body.style.overflow = 'hidden';
      if (mainEl) mainEl.setAttribute('aria-hidden', 'true');

      if (cleanupTrap) cleanupTrap();
      if (window.SEP?.modal?.trap) {
        cleanupTrap = window.SEP.modal.trap(dialogEl, {
          initialFocusEl: closeButton,
          onEscape: () => closeModal(),
        });
      } else if (closeButton) {
        closeButton.focus();
      }
    }

    function closeModal() {
      backdrop.classList.remove('is-visible');
      backdrop.setAttribute('aria-hidden', 'true');

      document.body.style.overflow = '';
      if (mainEl) mainEl.removeAttribute('aria-hidden');

      if (cleanupTrap) {
        cleanupTrap();
        cleanupTrap = null;
      }

      if (lastActiveEl && typeof lastActiveEl.focus === 'function') {
        try {
          lastActiveEl.focus();
        } catch {
          // ignore
        }
      }

      lastActiveEl = null;
    }

    // Attach listeners to all "More Info" buttons
    document.addEventListener('click', event => {
      const btn = event.target.closest('[data-role="details"]');
      if (!btn) return;

      const card = btn.closest('.book-card');
      if (!card) return;
      openModal(card, btn);
    });

    // Close button
    if (closeButton) {
      closeButton.addEventListener('click', closeModal);
    }

    // Click outside modal content closes
    backdrop.addEventListener('click', event => {
      if (event.target === backdrop) {
        closeModal();
      }
    });

  })();
  </script>
</body>
</html>
