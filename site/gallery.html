<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="description" content="Fourthwall storefront for St. Expedite Press." />
  <meta name="theme-color" content="#050807" />
  <meta name="color-scheme" content="dark" />
  <meta property="og:site_name" content="St. Expedite Press" />
  <meta property="og:type" content="website" />
  <meta property="og:title" content="Store &mdash; St. Expedite Press" />
  <meta property="og:description" content="Official Fourthwall storefront." />
  <title>Store &mdash; St. Expedite Press</title>

  <link rel="icon" href="assets/img/favicon.svg" type="image/svg+xml" />
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;600&family=Cormorant+Garamond:wght@300;400;600&display=swap" rel="stylesheet" />
  <link rel="stylesheet" href="assets/css/hero-bar.css" />
  <link rel="stylesheet" href="assets/css/footer.css" />
  <link rel="stylesheet" href="assets/css/base.css" />
  <link rel="stylesheet" href="assets/css/effects.css" />
  <link rel="stylesheet" href="assets/css/a11y.css" />
  <link rel="stylesheet" href="assets/css/content-shell.css" />

  <style>
    .header-nav a:focus-visible {
      border-color: rgba(42,255,138,0.48);
      background: rgba(42,255,138,0.08);
      filter: brightness(1.2) contrast(1.05);
      text-shadow: 0 0 10px var(--green-hot-1), 0 0 24px var(--green-hot-2);
    }

    .store-intro {
      max-width: 840px;
      margin: 2vh auto 2.6vh;
      text-align: center;
      line-height: 1.55;
      opacity: 0.95;
      text-shadow: 0 0 8px var(--green-3);
      font-size: 1.03rem;
    }

    .store-toolbar {
      max-width: 1080px;
      margin: 0 auto 1.2rem;
      display: flex;
      gap: 0.7rem;
      flex-wrap: wrap;
      justify-content: center;
      align-items: center;
    }

    .collection-pill,
    .store-link {
      border: 1px solid var(--green-2);
      background: rgba(0,0,0,0.72);
      color: var(--green-base);
      border-radius: 999px;
      padding: 0.5rem 0.95rem;
      font-family: "Cinzel", serif;
      letter-spacing: 0.14em;
      text-transform: uppercase;
      font-size: 0.74rem;
      text-decoration: none;
      cursor: pointer;
      box-shadow: 0 0 10px rgba(0,0,0,0.9), 0 0 14px var(--green-3);
      transition: 0.2s ease;
    }

    .collection-pill:hover,
    .store-link:hover,
    .collection-pill:focus-visible,
    .store-link:focus-visible {
      border-color: var(--green-hot-2);
      box-shadow: 0 0 12px var(--green-hot-2), 0 0 22px var(--green-hot-3);
    }

    .collection-pill.is-active {
      border-color: var(--green-hot-1);
      background: rgba(42,255,138,0.1);
      box-shadow: 0 0 14px var(--green-hot-1), 0 0 28px var(--green-hot-2);
    }

    .store-status {
      max-width: 980px;
      margin: 0.2rem auto 1.3rem;
      text-align: center;
      font-size: 0.95rem;
      opacity: 0.9;
      min-height: 1.5rem;
    }

    .store-trust {
      max-width: 1080px;
      margin: 0 auto 1rem;
      display: grid;
      gap: 0.8rem;
      grid-template-columns: repeat(3, minmax(0, 1fr));
    }

    @media (max-width: 860px) {
      .store-trust {
        grid-template-columns: 1fr;
      }
    }

    .store-trust__item {
      border: 1px solid rgba(42,255,138,0.2);
      border-radius: 14px;
      padding: 0.7rem 0.8rem;
      background: rgba(0,0,0,0.62);
      text-align: center;
      font-size: 0.86rem;
      letter-spacing: 0.06em;
      opacity: 0.95;
    }

    .store-grid {
      max-width: 1160px;
      margin: 0 auto 4rem;
      display: grid;
      grid-template-columns: repeat(4, minmax(0, 1fr));
      gap: 1.1rem;
    }

    @media (max-width: 1100px) {
      .store-grid {
        grid-template-columns: repeat(3, minmax(0, 1fr));
      }
    }

    @media (max-width: 820px) {
      .store-grid {
        grid-template-columns: repeat(2, minmax(0, 1fr));
      }
    }

    @media (max-width: 560px) {
      .store-grid {
        grid-template-columns: 1fr;
      }
    }

    .product-card {
      border: 1px solid rgba(42,255,138,0.24);
      border-radius: 20px;
      background: rgba(0,0,0,0.74);
      overflow: hidden;
      box-shadow: 0 0 12px rgba(0,0,0,0.9), 0 0 18px var(--green-3);
      display: flex;
      flex-direction: column;
      min-height: 100%;
      transition: 0.23s ease;
    }

    .product-card:hover,
    .product-card:focus-within {
      transform: translateY(-3px);
      border-color: var(--green-hot-2);
      box-shadow: 0 0 16px rgba(0,0,0,0.9), 0 0 26px var(--green-hot-2);
    }

    .product-link {
      color: inherit;
      text-decoration: none;
      display: flex;
      flex-direction: column;
      min-height: 100%;
    }

    .product-image-wrap {
      width: 100%;
      aspect-ratio: 1 / 1;
      background: radial-gradient(circle at 20% 15%, rgba(42,255,138,0.16), rgba(0,0,0,0.95) 68%);
      border-bottom: 1px solid rgba(42,255,138,0.12);
      overflow: hidden;
    }

    .product-image {
      width: 100%;
      height: 100%;
      object-fit: cover;
      display: block;
      filter: brightness(1.08) contrast(1.1);
      transition: 0.28s ease;
    }

    .product-card:hover .product-image {
      transform: scale(1.03);
      filter: brightness(1.16) contrast(1.22);
    }

    .product-body {
      padding: 0.9rem 0.95rem 1rem;
      display: flex;
      flex-direction: column;
      gap: 0.45rem;
    }

    .product-name {
      font-family: "Cinzel", serif;
      letter-spacing: 0.07em;
      text-transform: uppercase;
      font-size: 0.86rem;
      line-height: 1.35;
      text-shadow: 0 0 8px var(--green-2);
    }

    .product-price {
      font-size: 0.92rem;
      opacity: 0.9;
    }

    .empty-state {
      grid-column: 1 / -1;
      border: 1px dashed rgba(42,255,138,0.3);
      border-radius: 20px;
      padding: 1.6rem;
      text-align: center;
      background: radial-gradient(circle at 50% 0, rgba(42,255,138,0.14), rgba(0,0,0,0.92) 72%);
      box-shadow: 0 0 14px var(--green-3);
      letter-spacing: 0.05em;
    }

    .page-footer {
      margin-top: 4vh;
      text-align: center;
      font-size: 0.8rem;
      letter-spacing: 0.12em;
      opacity: 0.7;
    }

    .footer-store-link {
      text-transform: uppercase;
      letter-spacing: 0.12em;
    }
  </style>
</head>
<body>
  <a class="skip-link" href="#main">Skip to content</a>

  <div class="hero-bar" role="navigation" aria-label="Social media">
    <div class="hero-bar__inner">
      <a class="hero-bar__icon" href="https://x.com/stex_press" target="_blank" rel="noopener noreferrer" aria-label="X" title="X">
        <svg viewBox="0 0 24 24" aria-hidden="true" focusable="false" fill="none" stroke="currentColor" stroke-width="2.2" stroke-linecap="round"><path d="M6 6l12 12M18 6L6 18" /></svg>
      </a>
      <a class="hero-bar__icon" href="https://ecoamericana.substack.com/s/ephemera" target="_blank" rel="noopener noreferrer" aria-label="Substack" title="Substack">
        <svg viewBox="0 0 24 24" aria-hidden="true" focusable="false" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"><path d="M7 7h10M7 12h10M7 17h10" /></svg>
      </a>
      <a class="hero-bar__icon" href="https://t.me/+vvALfKUrw0k5NjYx" target="_blank" rel="noopener noreferrer" aria-label="Telegram" title="Telegram">
        <svg viewBox="0 0 24 24" aria-hidden="true" focusable="false" fill="none" stroke="currentColor" stroke-width="2" stroke-linejoin="round" stroke-linecap="round"><path d="M21 5 3 12l7 2 2 7 9-16Z" /><path d="M10 14 21 5" /></svg>
      </a>
      <a class="hero-bar__icon" href="https://github.com/orgs/St-Expedite-Press/repositories" target="_blank" rel="noopener noreferrer" aria-label="GitHub" title="GitHub">
        <svg viewBox="0 0 24 24" aria-hidden="true" focusable="false" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M9 19c-5 1.5-5-2.5-7-3m14 6v-3.87a3.37 3.37 0 0 0-.94-2.61c3.14-.35 6.44-1.54 6.44-7A5.44 5.44 0 0 0 20 4.77 5.07 5.07 0 0 0 19.91 1S18.73.65 16 2.48a13.38 13.38 0 0 0-7 0C6.27.65 5.09 1 5.09 1A5.07 5.07 0 0 0 5 4.77a5.44 5.44 0 0 0-1.5 3.78c0 5.42 3.3 6.61 6.44 7A3.37 3.37 0 0 0 9 18.13V22"/></svg>
      </a>
    </div>
  </div>

  <div class="texture--grain"></div>
  <div class="cursor-glow"></div>

  <main id="main" class="page">
    <header class="site-header">
      <div class="site-brand">
        <div class="site-eyebrow">ST. EXPEDITE PRESS</div>
        <h1 class="site-title">STORE</h1>
        <div class="site-subtitle">Powered by Fourthwall</div>
        <div class="site-header-divider"></div>
      </div>

      <nav class="header-nav">
        <a href="index.html">Portal</a>
        <a href="books.html">Books</a>
        <a href="gallery.html" aria-current="page">Merch</a>
        <a href="under-construction.html">Lab</a>
        <a href="mission.html">Mission</a>
        <a href="contact.html">Contact</a>
      </nav>
    </header>

    <section class="store-intro" aria-label="Store intro">
      <p>
        Official merchandise and limited drops from <strong>St. Expedite Press</strong>.
        Inventory is loaded live from the Fourthwall catalog.
      </p>
    </section>

    <section aria-label="Store controls">
      <div class="store-trust" aria-label="Store trust signals">
        <div class="store-trust__item">Secure checkout is handled offsite by Fourthwall.</div>
        <div class="store-trust__item">Inventory and price data are loaded live from the catalog.</div>
        <div class="store-trust__item">For order support, use <a href="contact.html">Contact</a>.</div>
      </div>
      <div id="store-toolbar" class="store-toolbar"></div>
      <div id="store-status" class="store-status" role="status" aria-live="polite"></div>
    </section>

    <section id="store-grid" class="store-grid" aria-label="Store products"></section>

    <footer class="page-footer" aria-label="Footer links">
      <a href="services.html">Services</a> // <a href="submit.html">Submission</a> // <a href="contact.html">Contact</a>
      <span id="footer-store-wrap" hidden> // <a id="footer-store-link" class="footer-store-link" href="#" target="_blank" rel="noopener noreferrer">Go to Full Store</a></span>
    </footer>
  </main>

  <script src="assets/js/cursor-glow.js"></script>
  <script>
    (function () {
      const toolbar = document.getElementById('store-toolbar');
      const status = document.getElementById('store-status');
      const grid = document.getElementById('store-grid');
      const footerStoreWrap = document.getElementById('footer-store-wrap');
      const footerStoreLink = document.getElementById('footer-store-link');

      if (!toolbar || !status || !grid || !footerStoreWrap || !footerStoreLink) return;

      let currentCollection = '';
      let shopUrl = 'https://shop.stexpedite.press';
      const storefrontEndpoints = [
        '/api/storefront',
      ];

      function setStatus(text) {
        status.textContent = text;
      }

      function normalizeShopUrl(value) {
        const raw = String(value || '').trim();
        if (!raw) return '';
        if (/^https?:\/\//i.test(raw)) return raw;
        return `https://${raw}`;
      }

      function formatMoney(value, currency) {
        const amount = Number(value);
        if (!Number.isFinite(amount)) return '';
        const code = String(currency || 'USD').toUpperCase();
        try {
          return new Intl.NumberFormat('en-US', { style: 'currency', currency: code }).format(amount);
        } catch {
          return `${amount.toFixed(2)} ${code}`;
        }
      }

      function productCard(product) {
        const name = String(product.name || 'Product');
        const slug = String(product.slug || '');
        const image = String(product.image || '');
        const price = formatMoney(product.priceValue, product.priceCurrency);
        const href = shopUrl && slug ? `${shopUrl.replace(/\/$/, '')}/products/${encodeURIComponent(slug)}` : shopUrl || '#';
        return `
          <article class="product-card">
            <a class="product-link" href="${href}" target="_blank" rel="noopener noreferrer" aria-label="Open ${name} on shop">
              <div class="product-image-wrap">
                ${image ? `<img class="product-image" src="${image}" alt="${name}" loading="lazy" decoding="async" />` : ''}
              </div>
              <div class="product-body">
                <div class="product-name">${name}</div>
                <div class="product-price">${price || 'View on store'}</div>
              </div>
            </a>
          </article>
        `;
      }

      function renderToolbar(collections) {
        const pills = collections.map((item) => {
          const slug = String(item.slug || '');
          const name = String(item.name || slug || 'Collection');
          const active = slug === currentCollection ? ' is-active' : '';
          return `<button class="collection-pill${active}" type="button" data-collection="${slug}">${name}</button>`;
        });

        toolbar.innerHTML = pills.join('');

        toolbar.querySelectorAll('[data-collection]').forEach((btn) => {
          btn.addEventListener('click', () => {
            const slug = String(btn.getAttribute('data-collection') || '').trim();
            if (!slug || slug === currentCollection) return;
            loadCatalog(slug);
          });
        });
      }

      function renderProducts(products) {
        if (!products.length) {
          grid.innerHTML = '<div class="empty-state">No products found in this collection yet.</div>';
          return;
        }
        grid.innerHTML = products.map(productCard).join('');
      }

      async function loadCatalog(collectionSlug) {
        const query = collectionSlug ? `?collection=${encodeURIComponent(collectionSlug)}` : '';
        setStatus('Loading storefront...');
        grid.innerHTML = '';

        try {
          let data = null;
          let lastError = 'Storefront unavailable';

          for (const endpoint of storefrontEndpoints) {
            try {
              const res = await fetch(`${endpoint}${query}`, { method: 'GET', cache: 'no-store' });
              const body = await res.json().catch(() => ({}));
              if (res.ok && body && body.ok) {
                data = body;
                break;
              }
              lastError = String(body && body.error ? body.error : `HTTP ${res.status}`);
            } catch (fetchErr) {
              const message = fetchErr && fetchErr.message ? fetchErr.message : 'Failed to fetch';
              lastError = `${endpoint} -> ${message}`;
            }
          }

          if (!data) {
            throw new Error(lastError);
          }

          currentCollection = String(data.collection || collectionSlug || '');
          shopUrl = normalizeShopUrl(data?.shop?.url || data?.shop?.domain || '');
          footerStoreWrap.hidden = false;
          footerStoreLink.setAttribute('href', shopUrl);
          renderToolbar(Array.isArray(data.collections) ? data.collections : []);
          renderProducts(Array.isArray(data.products) ? data.products : []);

          const shopName = String(data?.shop?.name || 'store');
          setStatus(`Loaded ${shopName} â€” ${currentCollection || 'catalog'}.`);
        } catch (err) {
          const message = err && err.message ? err.message : 'Storefront unavailable';
          setStatus(`Could not load storefront right now (${message}).`);
          footerStoreWrap.hidden = false;
          footerStoreLink.setAttribute('href', shopUrl);
          grid.innerHTML = `<div class="empty-state"><p>Could not load the live catalog from API.</p><p><a class="store-link" href="${shopUrl}" target="_blank" rel="noopener noreferrer">Open Store Directly</a></p></div>`;
        }
      }

      loadCatalog('');
    })();
  </script>
</body>
</html>
